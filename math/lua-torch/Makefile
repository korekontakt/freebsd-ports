# $FreeBSD$

PORTNAME=	torch
PORTVERSION=	0.20150819
PORTREVISION=	1
CATEGORIES=	math
PKGNAMEPREFIX=	${LUA_PKGNAMEPREFIX}

MAINTAINER=	jbeich@FreeBSD.org
COMMENT=	Scientific computing framework for Lua

LICENSE=	BSD3CLAUSE
LICENSE_FILE=	${WRKSRC}/COPYRIGHT.txt

BUILD_DEPENDS=	${LUA_PKGNAMEPREFIX}cwrap>0:${PORTSDIR}/devel/lua-cwrap
LIB_DEPENDS=	libTH.so:${PORTSDIR}/math/TH
RUN_DEPENDS=	${LUA_PKGNAMEPREFIX}paths>0:${PORTSDIR}/devel/lua-paths

USE_GITHUB=	yes
GH_PROJECT=	torch7
GH_TAGNAME=	cf186b7

USES=		cmake lua ninja uniquefiles:dirs
EXTRACT_AFTER_ARGS=	--exclude lib/TH # moved to math/TH
CMAKE_ARGS=	-DLUA_INCDIR="${LUA_INCDIR}" \
		-DLUA_LIBDIR="${LUA_LIBDIR}" \
		-DLUA_BINDIR="${PREFIX}/bin" \
		-DLUADIR="${LUA_MODSHAREDIR}" \
		-DLIBDIR="${LUA_MODLIBDIR}" \
		-DLUA="${LUA_CMD}" \
		-DLUA_VER="${LUA_VER}"
CFLAGS+=	-I${LOCALBASE}/include/TH
LDFLAGS+=	-L${LOCALBASE}/lib
PORTDOCS=	*
UNIQUE_PREFIX_FILES=	share/cmake/${PORTNAME}
PLIST_SUB=	PKGBASE=${PKGBASE}
USE_LDCONFIG=	yes

OPTIONS_DEFINE=	DOCS OPENMP
OPTIONS_DEFAULT=OPENMP

OPENMP_USES=	compiler:openmp
OPENMP_CMAKE_OFF=-DWITH_OPENMP=off

post-patch:
	@${REINPLACE_CMD} -e '/README/d' \
		-e '/doc/s,[^"]*/torch,${DOCSDIR},' \
		${WRKSRC}/CMakeLists.txt
	@${REINPLACE_CMD} -e '/SUBDIR.*TH/d' \
		${WRKSRC}/lib/CMakeLists.txt

.include <bsd.port.mk>
